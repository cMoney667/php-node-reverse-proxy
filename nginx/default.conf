upstream node_app {
    server node:3000;
}

upstream php_fpm {
    server php:9000;
}

server {
  listen 80;
  server_name _;

    # 1) Node first
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_intercept_errors on;
        error_page 404 = @php_fallback;

        proxy_pass http://node:3000;
    }

#   # --- Static assets served directly from PHP app's public/ (optional but nice) ---
#   location ~* \.(?:css|js|png|jpe?g|gif|ico|svg|woff2?|ttf|map)$ {
#     root /var/www/html/public;
#     try_files $uri =404;
#   }

    # 2) On 404 from Node, send to PHP front controller
    location @php_fallback {
        include /etc/nginx/fastcgi_params;

        # This path is ONLY required to exist in the PHP container.
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param SCRIPT_NAME /index.php;

        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_URI $request_uri;

        fastcgi_pass php:9000;
    }

    # 3) Optional: direct .php hits
    location ~ \.php$ {
        include /etc/nginx/fastcgi_params;

        # Again, use path as seen INSIDE the PHP container
        fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;

        fastcgi_param QUERY_STRING $query_string;
        fastcgi_pass php:9000;
    }
}
